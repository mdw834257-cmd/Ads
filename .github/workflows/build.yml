name: God Mode APK Builder

on:
  repository_dispatch:
    types: [build_apk]

jobs:
  build:
    name: Build Ultra-Secure APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Dependencies
        run: |
          npm install -g cordova
          npm install -g cordova-res
          
          # --- FIX: ADDED --ignore-scripts TO STOP HUSKY ERROR ---
          npm install -g javascript-obfuscator --ignore-scripts
          
          npm link javascript-obfuscator
          npm install cordova-plugin-admob-plus --save

      - name: Initialize App
        run: |
          cordova create myApp ${{ github.event.client_payload.package_name }} "${{ github.event.client_payload.app_name }}"
          cd myApp
          cordova platform add android

      # --- FETCH SOURCE ---
      - name: Fetch Source
        run: |
          SOURCE_FILE="${{ github.event.client_payload.source_path }}"
          if [ -f "$SOURCE_FILE" ]; then
            echo "‚úÖ Source file found at: $SOURCE_FILE"
            cp "$SOURCE_FILE" myApp/www/index.html
          else
            echo "‚ùå Error: Source file missing at $SOURCE_FILE"
            exit 1
          fi

      # --- INJECT ADMOB LOGIC ---
      - name: Inject AdMob System
        working-directory: ./myApp
        run: |
          node -e "
            const fs = require('fs');
            const enabled = '${{ github.event.client_payload.admob_config.enabled }}';
            
            if (enabled === 'true') {
                console.log('üí∞ Injecting AdMob System...');
                const bannerId = '${{ github.event.client_payload.admob_config.banner_id }}';
                const interId = '${{ github.event.client_payload.admob_config.inter_id }}';
                
                const adScriptContent = \`
                document.addEventListener('deviceready', async function() {
                     console.log('AdMob: Initializing...');
                     try {
                         if ('\${bannerId}'.length > 5) {
                             const banner = new admob.BannerAd({ adUnitId: '\${bannerId}' });
                             await banner.show();
                         }
                         if ('\${interId}'.length > 5) {
                             const interstitial = new admob.InterstitialAd({ adUnitId: '\${interId}' });
                             await interstitial.load();
                             setTimeout(() => { interstitial.show(); }, 5000);
                         }
                     } catch (e) { console.error('AdMob Error: ' + e); }
                }, false);
                \`;
                
                fs.writeFileSync('ad_logic.js', adScriptContent);
                let html = fs.readFileSync('www/index.html', 'utf8');
                const scriptTag = '<script>' + adScriptContent + '</script>';
                html = html.replace('</body>', scriptTag + '</body>');
                fs.writeFileSync('www/index.html', html);
                console.log('‚úÖ Injected AdMob Logic');
                
            } else {
                console.log('‚ÑπÔ∏è No AdMob configuration provided.');
            }
          "
          
          if [ "${{ github.event.client_payload.admob_config.enabled }}" == "true" ]; then
             APP_ID="${{ github.event.client_payload.admob_config.app_id }}"
             cordova plugin add cordova-plugin-admob-plus --variable APP_ID_ANDROID="$APP_ID"
          fi

      # --- üíÄ DARK CYBER GOD MODE ENCRYPTION üíÄ ---
      - name: üõ°Ô∏è Apply Dark Cyber Protection
        working-directory: ./myApp
        run: |
          npm link javascript-obfuscator
          
          node -e "
            const fs = require('fs');
            const scriptContent = \`
            const fs = require('fs');
            const JavaScriptObfuscator = require('javascript-obfuscator');
            const sourcePath = 'www/index.html';
            
            try {
                let originalCode = fs.readFileSync(sourcePath, 'utf8');
                const b64 = Buffer.from(originalCode).toString('base64');
                const hex = Buffer.from(b64).toString('hex');
                const finalEnc = Buffer.from(hex).toString('base64');
                
                let loaderScript = \\\`
                    (function(_0xInput){
                        console.log(\"HELLO KIDS üåö DARK CYBER ü•∂üñï\"); 
                        var _0xHex = window.atob(_0xInput);
                        var _0xBase = _0xHex.match(/.{1,2}/g).map(function(v){return String.fromCharCode(parseInt(v, 16))}).join('');
                        var _0xHtml = decodeURIComponent(escape(window.atob(_0xBase)));
                        document.open(); document.write(_0xHtml); document.close();
                    })(\"\\\${finalEnc}\");
                \\\`;
                
                console.log(\"üî• Applying 100x Obfuscation...\");
                const obfuscationResult = JavaScriptObfuscator.obfuscate(loaderScript, {
                    compact: true, simplify: true, identifierNamesGenerator: 'mangled', 
                    stringArray: true, stringArrayThreshold: 1, 
                    selfDefending: true, deadCodeInjection: true, 
                    debugProtection: true, disableConsoleOutput: true
                });
                
                const finalHtml = '<!DOCTYPE html><html><head><meta charset=\"utf-8\"></head><body><script>' + obfuscationResult.getObfuscatedCode() + '</script></body></html>';
                fs.writeFileSync(sourcePath, finalHtml);
                console.log(\"‚úÖ DARK CYBER Protection Applied!\");
            } catch (err) { console.error(\"Encryption Failed:\", err); process.exit(1); }
            \`;
            fs.writeFileSync('encrypt_engine.js', scriptContent);
          "
          
          node encrypt_engine.js

      # --- INJECT CONFIG ---
      - name: Inject Config
        working-directory: ./myApp
        run: |
          # Permissions
          if [ "${{ github.event.client_payload.permissions.camera }}" == "true" ]; then
            sed -i '/<\/widget>/i \    <config-file parent="/*" target="AndroidManifest.xml"><uses-permission android:name="android.permission.CAMERA" /></config-file>' config.xml
          fi
          if [ "${{ github.event.client_payload.permissions.mic }}" == "true" ]; then
             sed -i '/<\/widget>/i \    <config-file parent="/*" target="AndroidManifest.xml"><uses-permission android:name="android.permission.RECORD_AUDIO" /></config-file>' config.xml
          fi
          if [ "${{ github.event.client_payload.permissions.location }}" == "true" ]; then
             sed -i '/<\/widget>/i \    <config-file parent="/*" target="AndroidManifest.xml"><uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" /></config-file>' config.xml
          fi
          
          # Custom Icon
          if [ "${{ github.event.client_payload.has_custom_icon }}" == "true" ]; then
             ICON_FILE="../${{ github.event.client_payload.icon_path }}"
             if [ -f "$ICON_FILE" ]; then
                 cp "$ICON_FILE" www/icon.png
                 sed -i '/<\/widget>/i \    <icon src="www/icon.png" />' config.xml
             fi
          fi

      # --- INJECT PERMISSIONS SCRIPT ---
      - name: Inject Permissions Handler
        working-directory: ./myApp
        run: |
          cordova plugin add cordova-plugin-android-permissions
          
          node -e "
             const fs = require('fs');
             const permScript = \"<script>document.addEventListener('deviceready',function(){try{var p=cordova.plugins.permissions;var list=[];if(${{ github.event.client_payload.permissions.camera }})list.push(p.CAMERA);if(${{ github.event.client_payload.permissions.mic }})list.push(p.RECORD_AUDIO);if(${{ github.event.client_payload.permissions.location }})list.push(p.ACCESS_FINE_LOCATION);if(list.length>0){p.requestPermissions(list,function(s){},function(e){});}}catch(e){}},false);</script>\";
             let html = fs.readFileSync('www/index.html', 'utf8');
             html = html.replace('<body>', '<body>' + permScript);
             fs.writeFileSync('www/index.html', html);
          "

      # --- BUILD ---
      - name: Build Android APK
        working-directory: ./myApp
        run: cordova build android --debug -- --packageType=apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.client_payload.app_name }}-APK
          path: myApp/platforms/android/app/build/outputs/apk/debug/app-debug.apk
