name: God Mode APK Builder

on:
  repository_dispatch:
    types: [build_apk]

jobs:
  build:
    name: Build Ultra-Secure APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Dependencies
        run: |
          npm install -g cordova
          npm install -g cordova-res
          # Fix: Install obfuscator locally so 'require' works
          npm install javascript-obfuscator 

      - name: Initialize App
        run: |
          cordova create myApp ${{ github.event.client_payload.package_name }} "${{ github.event.client_payload.app_name }}"
          cd myApp
          cordova platform add android
          # Disable telemetry to prevent hanging
          cordova telemetry off

      # --- FETCH SOURCE ---
      - name: Fetch Source
        run: |
          SOURCE_FILE="${{ github.event.client_payload.source_path }}"
          if [ -f "$SOURCE_FILE" ]; then
            echo "‚úÖ Source file found at: $SOURCE_FILE"
            cp "$SOURCE_FILE" myApp/www/index.html
          else
            echo "‚ùå Error: Source file missing at $SOURCE_FILE"
            ls -R apk_source
            exit 1
          fi

      # --- üíÄ DARK CYBER ENCRYPTION (FIXED) ---
      - name: üõ°Ô∏è Apply Dark Cyber Protection
        env:
          NODE_PATH: ${{ github.workspace }}/node_modules
        working-directory: ./myApp
        run: |
          echo "üîí Applying HELLO KIDS DARK CYBER Protection..."
          
          # Link local node_modules to this folder so require works
          ln -s ../node_modules node_modules

          cat << 'EOF' > encrypt_engine.js
          const fs = require('fs');
          const JavaScriptObfuscator = require('javascript-obfuscator');
          
          const sourcePath = 'www/index.html';
          
          try {
              if (!fs.existsSync(sourcePath)) {
                  console.error("‚ùå File not found:", sourcePath);
                  process.exit(1);
              }

              let originalCode = fs.readFileSync(sourcePath, 'utf8');
              
              // 1. Triple Layer Encryption
              const b64 = Buffer.from(originalCode).toString('base64');
              const hex = Buffer.from(b64).toString('hex');
              const finalEnc = Buffer.from(hex).toString('base64');
              
              // 2. The Trap Loader Script
              let loaderScript = `
                  (function(_0xInput){
                      console.log("HELLO KIDS üåö DARK CYBER ü•∂üñï");
                      setInterval(function(){
                          var _0xStart = new Date().getTime();
                          debugger; 
                          if (new Date().getTime() - _0xStart > 100) {
                              while(true){};
                          }
                      }, 500);
                      var _0xHex = window.atob(_0xInput);
                      var _0xBase = _0xHex.match(/.{1,2}/g).map(function(v){return String.fromCharCode(parseInt(v, 16))}).join('');
                      var _0xHtml = decodeURIComponent(escape(window.atob(_0xBase)));
                      document.open(); document.write(_0xHtml); document.close();
                  })("${finalEnc}");
              `;
              
              console.log("üî• Applying 100x Obfuscation...");
              
              const obfuscationResult = JavaScriptObfuscator.obfuscate(loaderScript, {
                  compact: true,
                  simplify: true,
                  identifierNamesGenerator: 'mangled', 
                  identifiersPrefix: 'HELLO_KIDS',
                  renameGlobals: true,
                  stringArray: true,
                  stringArrayEncoding: ['rc4'],
                  stringArrayThreshold: 1, 
                  selfDefending: true, 
                  deadCodeInjection: true,
                  debugProtection: true,
                  disableConsoleOutput: true
              });
              
              const finalHtml = `<!DOCTYPE html><html><head><meta charset="utf-8"></head><body><script>${obfuscationResult.getObfuscatedCode()}</script></body></html>`;
              
              fs.writeFileSync(sourcePath, finalHtml);
              console.log("‚úÖ DARK CYBER Protection Applied!");
          } catch (err) {
              console.error("Encryption Failed:", err);
              process.exit(1);
          }
          EOF
          
          node encrypt_engine.js

      # --- INJECT CONFIG (ICON & PERMISSIONS XML) ---
      - name: Inject Config
        working-directory: ./myApp
        run: |
          # Permissions Injection into config.xml
          if [ "${{ github.event.client_payload.permissions.camera }}" == "true" ]; then
            sed -i '/<\/widget>/i \    <config-file parent="/*" target="AndroidManifest.xml"><uses-permission android:name="android.permission.CAMERA" /></config-file>' config.xml
          fi
          if [ "${{ github.event.client_payload.permissions.mic }}" == "true" ]; then
             sed -i '/<\/widget>/i \    <config-file parent="/*" target="AndroidManifest.xml"><uses-permission android:name="android.permission.RECORD_AUDIO" /></config-file>' config.xml
          fi
          if [ "${{ github.event.client_payload.permissions.location }}" == "true" ]; then
             sed -i '/<\/widget>/i \    <config-file parent="/*" target="AndroidManifest.xml"><uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" /></config-file>' config.xml
          fi

          # Icon Logic
          if [ "${{ github.event.client_payload.has_custom_icon }}" == "true" ]; then
             ICON_FILE="../${{ github.event.client_payload.icon_path }}"
             if [ -f "$ICON_FILE" ]; then
                 cp "$ICON_FILE" www/icon.png
                 sed -i '/<\/widget>/i \    <icon src="www/icon.png" />' config.xml
             fi
          fi

      # --- üí∞ INJECT ADMOB MONETIZATION (FIXED) ---
      - name: Inject AdMob Logic
        working-directory: ./myApp
        run: |
          # Check if user enabled AdMob
          if [ "${{ github.event.client_payload.admob_config.enabled }}" == "true" ]; then
              echo "üí∞ AdMob Enabled! Installing Plugin..."
              
              # Install Plugin using the provided App ID
              cordova plugin add cordova-plugin-admob-plus --variable APP_ID_ANDROID="${{ github.event.client_payload.admob_config.app_id }}"
              
              # Generate the Ad Logic Script
              cat << 'EOF' > www/ad_logic.js
              document.addEventListener('deviceready', async function() {
                  try {
                      console.log("üí∞ Initializing AdMob...");
                      
                      // BANNER AD
                      let bannerId = "${{ github.event.client_payload.admob_config.banner_id }}";
                      if(bannerId && bannerId.length > 5) {
                          const banner = new admob.BannerAd({ adUnitId: bannerId });
                          await banner.show(); 
                          console.log("‚úÖ Banner Show Called");
                      }

                      // INTERSTITIAL AD
                      let interId = "${{ github.event.client_payload.admob_config.inter_id }}";
                      if(interId && interId.length > 5) {
                          const interstitial = new admob.InterstitialAd({ adUnitId: interId });
                          await interstitial.load();
                          // Show Interstitial after 5 seconds to ensure app is loaded
                          setTimeout(async () => {
                              await interstitial.show();
                          }, 5000);
                      }
                  } catch (e) {
                      console.error("‚ùå AdMob Error: " + e);
                  }
              }, false);
              EOF

              # Inject the script tag into index.html
              sed -i '/<\/body>/i \    <script src="ad_logic.js"></script>' www/index.html
          else
              echo "‚ö†Ô∏è AdMob Not Configured by User."
          fi

      # --- INJECT PERMISSIONS SCRIPT (SAFER METHOD) ---
      - name: Inject Permissions Handler
        working-directory: ./myApp
        run: |
          cordova plugin add cordova-plugin-android-permissions
          # Use a separate file to avoid SED syntax errors with special chars
          echo "<script>document.addEventListener('deviceready',function(){try{var p=cordova.plugins.permissions;var list=[];if(${{ github.event.client_payload.permissions.camera }})list.push(p.CAMERA);if(${{ github.event.client_payload.permissions.mic }})list.push(p.RECORD_AUDIO);if(${{ github.event.client_payload.permissions.location }})list.push(p.ACCESS_FINE_LOCATION);if(list.length>0){p.requestPermissions(list,function(s){},function(e){});}}catch(e){}},false);</script>" > perm_script.txt
          
          # Inject content of text file into index.html
          sed -i '/<body>/r perm_script.txt' www/index.html

      # --- BUILD ---
      - name: Build Android APK
        working-directory: ./myApp
        run: cordova build android --debug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.client_payload.app_name }}-APK
          path: myApp/platforms/android/app/build/outputs/apk/debug/app-debug.apk
